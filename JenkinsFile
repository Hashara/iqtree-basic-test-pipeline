// jenkins file for the basic test pipeline
pipeline {
    agent any
    parameters {
        // bool for build
        booleanParam(defaultValue: true, description: 'Build the project?', name: 'BUILD')
        string (defaultValue: 'master', description: 'Branch to build', name: 'BRANCH')

        // bool for config repo
        booleanParam(defaultValue: true, description: 'Clone the config repo?', name: 'CLONE_CONFIG_REPO')


        // bool for test
        booleanParam(defaultValue: true, description: 'Run the NN?', name: 'NN')
        booleanParam(defaultValue: true, description: 'Run the GPU?', name: 'GPU')
        booleanParam(defaultValue: true, description: 'Run with partition?', name: 'USE_PARTITION')

        // dataset name
        string (defaultValue: 'basic_test', description: 'Dataset name in the config repo', name: 'DATASET')

        // test options
        string (defaultValue: 'TESTMERGEONLY', description: '-m option', name: 'M_OPTION')
        string (defaultValue: 'false', description: '--mset option', name: 'MSET_OPTION')
        string (defaultValue: 'false', description: '--mrate option', name: 'MRATE_OPTION')
        string (defaultValue: 'false', description: 'Other options', name: 'OTHER_OPTIONS')
        string(defaultValue: '1', name: 'N_ATTEMPT', description: 'Number of attempt')  // in the later stage convert this to int

     }
     options {
             skipStagesAfterUnstable()
     }
     environment {
        IQTREE_GIT_URL = "https://github.com/iqtree/iqtree2.git"
        NCI_ALIAS = "nci_gadi"
        WORKING_DIR = "/scratch/dx61/sa0557/iqtree2/ci-cd"
        GIT_REPO = "iqtree2"
        BUILD_SCRIPTS = "${WORKING_DIR}/build-scripts"
        IQTREE_DIR = "${WORKING_DIR}/${GIT_REPO}"
        IQTREE_CONFIG_REPO = "https://github.com/Hashara/iqtree-test-config.git"
        IQTREE_CONFIG_DIR = "${WORKING_DIR}/iqtree-test-config"
        LOCAL_WD = "/Users/u7826985/Projects/iqtree-pipelines/local_wd"
        CONFIG_REPO_DIR = "iqtree-test-config"
        IQTREE_CONFIG_REPO_LOCAL = "${WORKING_DIR}/${CONFIG_REPO_DIR}"
        DATASET_DIR = "${WORKING_DIR}/data"

        // params to env variables
        N_ATTEMPT = "${params.N_ATTEMPT}"
        M_OPTION = "${params.M_OPTION}"
        MSET_OPTION = "${params.MSET_OPTION}"
        MRATE_OPTION = "${params.MRATE_OPTION}"
        OTHER_OPTIONS = "${params.OTHER_OPTIONS}"
        USE_PARTITION = "${params.USE_PARTITION}"

        TEST_SCRIPTS_DIR = "${WORKING_DIR}/test_scripts"


    }
    stages {
        stage('Build') {
            steps {
                // if build is true then echo build
                script {
                    if (params.BUILD) {
                        echo 'Building..'
                        // trigger jenkins iqtree-build-pipeline
                        build job: 'iqtree-build-pipeline', parameters: [string(name: 'BRANCH', value: BRANCH)]

                    }
                    else {
                        echo 'Skip build..'
                    }
                }
            }
        }
        stage ('Cloning config repo') {
            steps {
                script {
                    if (params.CLONE_CONFIG_REPO) {
                       echo "featching ${IQTREE_CONFIG_REPO}"
                       sh "mkdir -p ${LOCAL_WD}"
                       dir ("${LOCAL_WD}") {
                           git credentialsId: 'git-PAT', branch: 'master', url: "${IQTREE_CONFIG_REPO}"
                       }
                    }
                    else {
                        echo 'Skip cloning config repo..'
                    }


                }
            }

        }
        stage("reading config file") {
            steps {
                script {
                    echo "section: reading config file"

                    try {
                        def config = readYaml file: "${LOCAL_WD}/${DATASET}/data/configs.yaml"
                        echo "config: ${config}"

                        // copy dataset to remote working directory
                        echo "copying data files to NCI"
                        sh "scp -r ${LOCAL_WD}/${DATASET}/data ${NCI_ALIAS}:${DATASET_DIR}"

                        // read configs and assign to variables
                        env.ALIGNMENT = config['data']['data_files']['alignment']

                        //check partitions value is existing
                        if (config['data']['data_files']['partitions']) {
                            env.PARTITIONS = config['data']['data_files']['partitions']
                        }
                        else {
                            env.PARTITIONS = "false"
                        }

                        // check tree value is existing
                        if (config['data']['data_files']['tree']) {

                            env.TREE = config['data']['data_files']['tree']
                        }
                        else {
                            env.TREE = "false"
                        }

                        // create dynamic env variables
                        def N_ATTEMPT_INT = params.N_ATTEMPT.toInteger()
                        def envFileContent = """
                            #!/bin/bash
                            export NATTEMPT=${N_ATTEMPT_INT} # number of attempts
                            export M_OPTION=${M_OPTION} # MF/TESTMERGEONLY/TESTONLY ....
                            export MRATE_OPTION=${MRATE_OPTION} # -mrate option
                            export MSET_OPTION=${MSET_OPTION} # -mset option
                            export OTHER_OPTIONS=${OTHER_OPTIONS} # other options

                            # data files
                            export ALIGNMENT=${ALIGNMENT}
                            export PARTITION=${PARTITIONS}
                            export TREE=${TREE}
                            export USE_PARTITION=${USE_PARTITION}
                        """

                        // write env variables to a file
                        writeFile file: "helpers/env.sh", text: envFileContent



                       //  copy env configs to the remote working directory
                        sh "scp -r helpers ${NCI_ALIAS}:${WORKING_DIR}"

                        // copy csv path to the remote working directory
                        sh "scp ${LOCAL_WD}/${DATASET}/csv/input.csv ${NCI_ALIAS}:${WORKING_DIR}"

                        // copy test scripts
                        sh "scp -r test_scripts ${NCI_ALIAS}:${WORKING_DIR}"

                        // give execution permission to test_scripts
                        sh "ssh ${NCI_ALIAS} chmod 777 ${WORKING_DIR}/test_scripts/*"


                    } catch (err) {
                        echo "Error reading config file: ${err}"
                    }



                }
            }
        }
        stage ("Test from script"){
            steps {
                script {
                    echo "section: Test from script"

                    def N_ATTEMPT_INT = params.N_ATTEMPT.toInteger()

                    sh """
                            ssh ${NCI_ALIAS} << EOF
                            source ${WORKING_DIR}/helpers/create_env.sh
                            source ${WORKING_DIR}/helpers/env.sh
                            printenv
                            /bin/bash ${TEST_SCRIPTS_DIR}/testFactory.sh

                            EOF
                        """
                }
            }
        }
        stage('Test: Single threaded'){
            steps {
                echo 'Testing..'

            }
        }
        stage('Test: mpi') {

            steps {
                    /*

                        1. build-mpi --> build the mpi version of iqtree2
                        2. build-wompi --> build the non-mpi + openmp version of iqtree2
                        3. build-nn --> build the non-mpi + openmp + NN version of iqtree2
                        4. build-nn-mpi --> build the mpi + NN version of iqtree2
                        4. build-gpu-nn --> build the non-mpi (openmp) + openmp + NN + GPU version of iqtree2
                        6. build-gpu-nn-mpi --> build the mpi + NN + GPU version of iqtree2
                     */
                echo 'Testing..'
            }
        }
         stage('Test: wompi') {

            steps {
                    /*

                        1. build-mpi --> build the mpi version of iqtree2
                        2. build-wompi --> build the non-mpi + openmp version of iqtree2
                        3. build-nn --> build the non-mpi + openmp + NN version of iqtree2
                        4. build-nn-mpi --> build the mpi + NN version of iqtree2
                        4. build-gpu-nn --> build the non-mpi (openmp) + openmp + NN + GPU version of iqtree2
                        6. build-gpu-nn-mpi --> build the mpi + NN + GPU version of iqtree2
                     */
                echo 'Testing..'
            }
        }

        stage('Test: hybrid') {

            steps {
                    /*

                        1. build-mpi --> build the mpi version of iqtree2
                        2. build-wompi --> build the non-mpi + openmp version of iqtree2
                        3. build-nn --> build the non-mpi + openmp + NN version of iqtree2
                        4. build-nn-mpi --> build the mpi + NN version of iqtree2
                        4. build-gpu-nn --> build the non-mpi (openmp) + openmp + NN + GPU version of iqtree2
                        6. build-gpu-nn-mpi --> build the mpi + NN + GPU version of iqtree2
                     */
                echo 'Testing..'
            }
        }

        stage('Test: nn') {

            steps {
                    /*

                        1. build-mpi --> build the mpi version of iqtree2
                        2. build-wompi --> build the non-mpi + openmp version of iqtree2
                        3. build-nn --> build the non-mpi + openmp + NN version of iqtree2
                        4. build-nn-mpi --> build the mpi + NN version of iqtree2
                        4. build-gpu-nn --> build the non-mpi (openmp) + openmp + NN + GPU version of iqtree2
                        6. build-gpu-nn-mpi --> build the mpi + NN + GPU version of iqtree2
                     */
                echo 'Testing..'
            }
        }

        stage('Test: nn-mpi') {

            steps {
                    /*

                        1. build-mpi --> build the mpi version of iqtree2
                        2. build-wompi --> build the non-mpi + openmp version of iqtree2
                        3. build-nn --> build the non-mpi + openmp + NN version of iqtree2
                        4. build-nn-mpi --> build the mpi + NN version of iqtree2
                        4. build-gpu-nn --> build the non-mpi (openmp) + openmp + NN + GPU version of iqtree2
                        6. build-gpu-nn-mpi --> build the mpi + NN + GPU version of iqtree2
                     */
                echo 'Testing..'
            }
        }

        stage('Test: nn-hybrid') {

            steps {
                    /*

                        1. build-mpi --> build the mpi version of iqtree2
                        2. build-wompi --> build the non-mpi + openmp version of iqtree2
                        3. build-nn --> build the non-mpi + openmp + NN version of iqtree2
                        4. build-nn-mpi --> build the mpi + NN version of iqtree2
                        4. build-gpu-nn --> build the non-mpi (openmp) + openmp + NN + GPU version of iqtree2
                        6. build-gpu-nn-mpi --> build the mpi + NN + GPU version of iqtree2
                     */
                echo 'Testing..'
            }
        }
        stage('Test: gpu-nn') {

            steps {
                    /*

                        1. build-mpi --> build the mpi version of iqtree2
                        2. build-wompi --> build the non-mpi + openmp version of iqtree2
                        3. build-nn --> build the non-mpi + openmp + NN version of iqtree2
                        4. build-nn-mpi --> build the mpi + NN version of iqtree2
                        4. build-gpu-nn --> build the non-mpi (openmp) + openmp + NN + GPU version of iqtree2
                        6. build-gpu-nn-mpi --> build the mpi + NN + GPU version of iqtree2
                     */
                echo 'Testing..'
            }
        }
        stage('Test: gpu-nn-mpi') {

            steps {
                    /*

                        1. build-mpi --> build the mpi version of iqtree2
                        2. build-wompi --> build the non-mpi + openmp version of iqtree2
                        3. build-nn --> build the non-mpi + openmp + NN version of iqtree2
                        4. build-nn-mpi --> build the mpi + NN version of iqtree2
                        4. build-gpu-nn --> build the non-mpi (openmp) + openmp + NN + GPU version of iqtree2
                        6. build-gpu-nn-mpi --> build the mpi + NN + GPU version of iqtree2
                     */
                echo 'Testing..'
            }
        }
        stage('Test: gpu-nn-hybrid') {

            steps {
                    /*

                        1. build-mpi --> build the mpi version of iqtree2
                        2. build-wompi --> build the non-mpi + openmp version of iqtree2
                        3. build-nn --> build the non-mpi + openmp + NN version of iqtree2
                        4. build-nn-mpi --> build the mpi + NN version of iqtree2
                        4. build-gpu-nn --> build the non-mpi (openmp) + openmp + NN + GPU version of iqtree2
                        6. build-gpu-nn-mpi --> build the mpi + NN + GPU version of iqtree2
                     */
                echo 'Testing..'
            }
        }

    }
}

// souce the env in to the nci
def void source_env(){
    sh """
        ssh ${NCI_ALIAS} << 'EOF'
        source ${WORKING_DIR}/helpers/create_env.sh ${N_ATTEMPT} ${M_OPTION} ${MRATE_OPTION} ${MSET_OPTION} ${OTHER_OPTIONS} ${ALIGNMENT} ${PARTITIONS} ${TREE} ${USE_PARTITION}

        EOF
    """

}